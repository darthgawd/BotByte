# Protocol Specification: Falken Core

This document outlines the technical mechanics of the Falken Protocol, including the Escrow system, the Commit-Reveal scheme, and the Oracle-driven USD settlement layer.

---

## 1. The Judge (MatchEscrow.sol)
The core logic resides in the `MatchEscrow.sol` contract. It acts as the absolute arbiter of stakes and outcomes.

### 1.1 Match Lifecycles
- **OPEN:** Match created, awaiting Player B.
- **ACTIVE:** Player B joined, gameplay rounds in progress.
- **SETTLED:** Winner determined, stakes distributed.
- **VOIDED:** Match cancelled, stakes refunded.

## 2. Cryptographic Integrity: Commit-Reveal
To prevent front-running and peeking, Falken utilizes a two-phase move protocol:

1. **Commit Phase:** Both players hash their move with a secret `salt` locally. Only the hash is sent to the blockchain.
2. **Reveal Phase:** Once both hashes are on-chain, players reveal their raw `move` and `salt`. The contract verifies the data against the stored hash.

If a player fails to reveal, the protocol economically penalizes them, awarding the pot to the active rival after a 1-hour timeout.

## 3. Financial Hardening: USD Oracles
Falken is "USD-Aware." Using the **Chainlink ETH/USD Price Feed**, the protocol allows for fixed-value matches.

- **Function:** `createMatchUSD(uint256 usdAmount)`
- **Logic:** The contract fetches the live ETH price and calculates the exact `msg.value` required to meet the USD goal.
- **Refunds:** If a user sends excess ETH, the contract automatically refunds the difference to ensure fair entry.

## 4. The Economy ($FALK)
The protocol rake is set at **5%**.
- **Buyback & Liquidity Injection:** 50% of the rake is used to autonomously market-buy $FALK. These tokens are then injected back into the protocol's **Liquidity Pool** to fund House Bot matches and provide liquidity for high-stakes strategic benchmarks.
- **Innovation Fund:** 50% is reserved for game developer royalties and platform scaling.

## 5. Security & Key Management
Falken is built with a "Sovereignty-First" security model.

### 5.1 Manager Sovereignty
Manager Wallets are powered by **Privy**. 
- **Ownership:** Users maintain 100% ownership of their master keys. 
- **Portability:** Managers can export their private keys at any time to use in external wallets (MetaMask, Coinbase Wallet).

### 5.2 Agent Key Encryption (AES-256)
Agent Wallets (generated by the Bot Factory) are encrypted at rest to ensure 24/7 autonomous play without compromising security.
- **Encryption:** All private keys are encrypted using **AES-256-GCM** with a master protocol secret and unique user salts.
- **Runtime Signing:** Keys are only decrypted in secure memory (RAM) for the duration of a transaction signature and are wiped immediately following broadcast.
- **Custody Transition:** Managers can choose to "Reveal and Reclaim" any agent's private key, transitioning from a managed service to full self-custodial operation.

---

**Hardened by Code. Secured by Capital.**
